<!DOCTYPE HTML>
<html manifest="manifest.appcache">
  <head>
    <title>ArduPilot</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/styles.css">
    <script type="text/javascript" src="/js/config.js"></script>
    <script type="text/javascript" src="/js/cors.js"></script>
    <script type="text/javascript" src="/js/mavlink.js"></script>
  </head>
<body>

<p><a href="/index.html"><img src="/images/main_logo.png" alt="ArduPilot"></a></p>
<h1>Video Streaming</h1>

<p><input type="submit" name="action" value="Refresh Camera List" onclick="refresh();"></p>

<table id="rtsp_table" class="parameters">
  <tr><th>Device</th><th>Camera Name</th><th class="alnright">RTSP Mount Point</th><th>Streaming Quality</th><th>Quality Setting</th</tr>
</table>
<script>
    var VideoPresetsEnum = {
        VIDEO_320x240x15: 0, VIDEO_640x480x15: 1, VIDEO_1280x720x15: 2,
        VIDEO_320x240x30: 3, VIDEO_640x480x30: 4, VIDEO_1280x720x30: 5,
        VIDEO_320x240x60: 6, VIDEO_640x480x60: 7, VIDEO_1280x720x60:8
    };
    var VideoPresetsName = [
        "320x240 15fps", "640x480 15fps", "1280x720 15fps",
        "320x240 30fps", "640x480 30fps", "1280x720 30fps",
        "320x240 60fps", "640x480 60fps", "1280x720 60fps"
    ];

    // 0 - name
    // 1 - mtpt
    // 2 - camtype
    function fill_rtsp_table(cam_data) {
        console.log(cam_data);
        var table = document.getElementById("rtsp_table");

        // delete any existing rows
        var nrows = table.rows.length;
        for (var i=nrows-1; i>0; i--) {
            table.deleteRow(i);
        }

        if (cam_data == "ERROR\n") {
            console.log("error str");
            alert("Cannot connect to the local RTSP Stream server");    
        } else {
            var plist;
            try {
                plist = JSON.parse(cam_data);
                plist.sort(function(a,b) {
                    if (a.mount < b.mount) {
                        return -1;
                    }
                    if (a.mount > b.mount) {
                        return 1;
                    }
                    return 0;
                });
            } catch(e) {
                console.log(e);
                return;
            }

            var n = plist.length;
            for (var i=0; i<n; i++) {
                var row = table.insertRow(table.rows.length);
                var rowdata = plist[i];
                row.insertCell(0).innerHTML = rowdata.dev_mount;
                row.insertCell(1).innerHTML = rowdata.name;
                var mount_url = "rtsp://10.0.1.128:8554" + rowdata.mount;
                row.insertCell(2).innerHTML = mount_url;
                var cameratype;
                var auto_qual_string;
                var manual_qual_string;
                var form_quality = "form_quality" + i;
                var quality_select_box = "quality_select_box"+i;
                var set_quality_button = "set_quality_button"+i;

                if (rowdata.camtype == 0) {
                    cameratype = "Software Encoding";
                    auto_qual_string = "Auto (SW)";
                    manual_qual_string = "Manual (SW)";
                } else if (rowdata.camtype == 1) {
                    cameratype = "Mixed Encoding";
                    auto_qual_string = "Auto (SW)";
                    manual_qual_string = "Manual (HW)";
                } else if (rowdata.camtype == 2) {
                    cameratype = "Hardware Encoding";
                    auto_qual_string = "Auto (HW)";
                    manual_qual_string = "Manual (HW)";
                }
                console.log(rowdata.camtype);
                row.insertCell(3).innerHTML = '<form id="' + form_quality + '"><input type="radio" id=auto' + i + ' name=streamtype' + i + ' value="auto" checked="checked">'+ auto_qual_string + '<input type="radio" id=manual' + i + ' name=streamtype' + i + ' value="manual">' + manual_qual_string + '</form>'
                row.insertCell(4).innerHTML = '<select id="' + quality_select_box + '"></select>' + '<button type="submit" value="' + i.toString() + '" onclick="send_settings(this)">Set</button>';
                
                var select = document.getElementById(quality_select_box);
                for (var j = 0; j < Object.keys(VideoPresetsEnum).length; j++) {
                    var test_value = 0;
                    test_value = 1 << j;
                    if (test_value & rowdata.frame_property_bitmask) {
                        console.log("Supports " + VideoPresetsName[j]);
                        select.options[select.options.length] = new Option(VideoPresetsName[j], j);
                    }
                }

                // for(index in myobject) {
                //     select.options[select.options.length] = new Option(myobject[index], index);
                // }
            }
        }
    }

    function send_settings(button) {
        console.log("Reached this " + button.value);
        var table = document.getElementById("rtsp_table");
        var quality_select_box = document.getElementById("quality_select_box" + button.value);
        var auto_button = document.getElementById("auto" + button.value);
        var manual_button = document.getElementById("manual" + button.value);
        // console.log("Auto checked - " + auto_button.checked + " Manual Checked - " + manual_button.checked);
        var qual_setting = 0;
        if (manual_button.checked) {
            qual_setting = 1 << quality_select_box.value;
        }
        console.log("QualValue - " + qual_setting);
        // all that we need to send is the device mtpt and its quality
        // var rowdata = table.rows[parseInt(button.value)];
    }

    function refresh() {
        command_send("get_camera_details()", { "onload" : fill_rtsp_table });
    }

</script>
</html>