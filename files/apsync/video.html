<!DOCTYPE HTML>
<html manifest="manifest.appcache">
  <head>
    <title>ArduPilot</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/styles.css">
    <script type="text/javascript" src="/js/config.js"></script>
    <script type="text/javascript" src="/js/cors.js"></script>
    <script type="text/javascript" src="/js/mavlink.js"></script>
  </head>
<body>

<p><a href="/index.html"><img src="/images/main_logo.png" alt="ArduPilot"></a></p>
<h1>Video Streaming</h1>
<div id="serverStoppedDiv">
<p>Network Interface: <select id="if_select_box"></select><button type="submit" value="set_if" onclick="start_server();">Start RTSP Server</button></p>
</div>
<div id="serverStartedDiv">
<p><input type="submit" name="action" value="Refresh Camera List" onclick="refresh();"></p>
<table id="rtsp_table" class="parameters">
  <tr><th>Device</th><th>Camera Name</th><th class="alnright">RTSP Mount Point</th><th>Quality</th><th>Record</th><th>Apply</th></tr>
</table>
</div>
<script>
    var VideoPresetsEnum = {
        VIDEO_320x240x15: 0, VIDEO_640x480x15: 1, VIDEO_1280x720x15: 2,
        VIDEO_320x240x30: 3, VIDEO_640x480x30: 4, VIDEO_1280x720x30: 5,
        VIDEO_320x240x60: 6, VIDEO_640x480x60: 7, VIDEO_1280x720x60: 8
    };
    var VideoPresetsName = [
        "320x240 15fps", "640x480 15fps", "1280x720 15fps",
        "320x240 30fps", "640x480 30fps", "1280x720 30fps",
        "320x240 60fps", "640x480 60fps", "1280x720 60fps"
    ];

    var AUTO_PRESET = 1024;

    window.onload = refresh;

    // 0 - name
    // 1 - mtpt
    // 2 - camtype
    function removeOptions(selectbox) {
        var i;
        for(i = selectbox.options.length - 1 ; i >= 0 ; i--) {
            selectbox.remove(i);
        }
    }

    function start_server() {
        var select = document.getElementById("if_select_box");
        console.log(select.value);
        var interface = select.value;
        command_send("start_rtsp_server(" + interface + ")", {"onload" : refresh});
    }

    function fill_interface_list(interface_list) {
        console.log(interface_list);
        var select = document.getElementById("if_select_box");
        removeOptions(select);
        var iflist = JSON.parse(interface_list);
        var interfaces = iflist["interfaces"];
        for (var i = 0; i < interfaces.length; i++) {
            select.options[select.options.length] = new Option(interfaces[i], interfaces[i]);
        }
    }

    function fill_rtsp_table(cam_data) {
        console.log(cam_data);
        var table = document.getElementById("rtsp_table");

        // delete any existing rows
        var nrows = table.rows.length;
        for (var i=nrows-1; i>0; i--) {
            table.deleteRow(i);
        }

        if (cam_data == "ERROR\n") {
            console.log("error str");
            document.getElementById("serverStartedDiv").style.display = 'none';
            document.getElementById("serverStoppedDiv").style.display = 'block';
            command_send("get_interfaces()", { "onload" : fill_interface_list });
            // alert("Cannot connect to the local RTSP Stream server");    
        } else {
            document.getElementById("serverStartedDiv").style.display = 'block';
            document.getElementById("serverStoppedDiv").style.display = 'none';
            var plist;
            try {
                plist = JSON.parse(cam_data);
                plist.sort(function(a,b) {
                    if (a.mount < b.mount) {
                        return -1;
                    }
                    if (a.mount > b.mount) {
                        return 1;
                    }
                    return 0;
                });
            } catch(e) {
                console.log(e);
                return;
            }

            var n = plist.length;
            for (var i=0; i<n; i++) {
                var row = table.insertRow(table.rows.length);
                var rowdata = plist[i];
                var device_cell = row.insertCell(0);
                var ip = rowdata.ip;
                var port = rowdata.port;
                device_cell.innerHTML = rowdata.dev_mount;
                device_cell.id = "device" + i;
                row.insertCell(1).innerHTML = rowdata.name;
                var mount_url = "rtsp://" + ip + ":" + port + rowdata.mount;
                row.insertCell(2).innerHTML = mount_url;
                var cameratype;
                var auto_qual_string;
                var manual_qual_string;
                var form_quality = "form_quality" + i;
                var quality_select_box = "quality_select_box"+i;
                var set_quality_button = "set_quality_button"+i;
                var record_video_checkbox = "record"+i;

                var current_quality = rowdata.current_quality;

                if (rowdata.camtype == 0) {
                    cameratype = "Software Encoding";
                    auto_qual_string = "Auto (SW)";
                    manual_qual_string = "Manual (SW)";
                } else if (rowdata.camtype == 1) {
                    cameratype = "UVC Camera";
                    auto_qual_string = "Auto (SW)";
                    manual_qual_string = "Manual (HW)";
                } else if (rowdata.camtype == 2) {
                    cameratype = "Hardware Encoding";
                    auto_qual_string = "Auto (HW)";
                    manual_qual_string = "Manual (HW)";
                }
                console.log(rowdata.camtype);
                // row.insertCell(3).innerHTML = '<form id="' + form_quality + '"><input type="radio" id=auto' + i + ' name=streamtype' + i + ' value="auto" checked="checked">'+ auto_qual_string + '<input type="radio" id=manual' + i + ' name=streamtype' + i + ' value="manual">' + manual_qual_string + '</form>'
                row.insertCell(3).innerHTML = '<select id="' + quality_select_box + '"></select>';
                row.insertCell(4).innerHTML = '<input type="checkbox" id=' + record_video_checkbox + ' margin: auto; text-align:center; >';
                row.insertCell(5).innerHTML = '<button type="submit" value="' + i.toString() + '" onclick="send_settings(this)">Set</button>';

                var select = document.getElementById(quality_select_box);
                select.options[select.options.length] = new Option("Auto", AUTO_PRESET);
                for (var j = 0; j < Object.keys(VideoPresetsEnum).length; j++) {
                    var test_value = 0;
                    test_value = 1 << j;
                    if (test_value & rowdata.frame_property_bitmask) {
                        console.log("Supports " + VideoPresetsName[j]);
                        select.options[select.options.length] = new Option(VideoPresetsName[j], j);
                    }
                }
                document.getElementById(quality_select_box).value = current_quality;
            }
        }
    }

    function send_settings(button) {
        console.log("Reached this " + button.value);
        var table = document.getElementById("rtsp_table");
        var quality_select_box = document.getElementById("quality_select_box" + button.value);
        var record_video_checkbox = document.getElementById("record"+button.value);

        var device_name = document.getElementById("device" + button.value).innerHTML;
        // console.log("Auto checked - " + auto_button.checked + " Manual Checked - " + manual_button.checked);
        var qual_setting = quality_select_box.value;

        var record_val;

        if (record_video_checkbox.checked == true) {
            record_val = 1;
        } else {
            record_val = 0;
        }

        var sdp_string = "SDP$" + device_name + " " + qual_setting + " " + record_val;
        command_send("set_device_quality(" + sdp_string + ")", {"onload" : after_sdp});
        console.log("QualValue - " + sdp_string);
        // console.log()
        // all that we need to send is the device mtpt and its quality
        // var rowdata = table.rows[parseInt(button.value)];
    }

    function after_sdp() {
        console.log("SDP string sent");
    }

    function refresh() {
        command_send("get_camera_details()", { "onload" : fill_rtsp_table });
    }

</script>
</html>